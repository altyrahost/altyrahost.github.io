<!DOCTYPE html>
<html lang="en">
    <header>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="">
        <meta name="author" content="">
        <link rel="icon" href="media/img/altyra.png">
        <title>Altyra</title>
        <link rel="stylesheet" href="css/main.css">
        <link rel="stylesheet" href="css/fonts.css">

        <link rel="stylesheet" href="css/boxicons/css/animations.css">
        <link rel="stylesheet" href="css/boxicons/css/boxicons.css">
    </header>
    
<body>
    <div id="success-display">
        <div id="success-display-box">
            <i class='bx bxs-check-circle' style="color: white; font-size: 1.25rem;"></i>
    
            <h1 class="slide-desc" style="color: white; margin-left: .5rem;"><span id="success-text"></span></h1>
        </div>
    </div>
    
    <div id="fail-display">
        <div id="fail-display-box">
            <i class='bx bxs-x-circle' style="color: white; font-size: 1.25rem;"></i>
    
            <h1 class="slide-desc" style="color: white; margin-left: .5rem;"><span id="fail-text"></span> :(</h1>
        </div>
    </div>
    <div id="done-wrapper" style="display: none;opacity: 0">
        <div id="done-display">
            <div class="data-flex" style="gap: 0;">
                <img src="media/img/plane.gif" alt="" style="width: 4rem;" id="submitimg">
                <h1>Your flight has been submitted!</h1>
            </div>

            <h2 style="margin-top: 2rem;">We highly hope it was fun onboard of Griffin's Air</h2>
            <h3>You can now reset the form and submit another one or close this page as your information has been processed :)</h3>
            <div class="data-flex" id="submitbuttons">

                <button class="data-flex alt" style="gap: .25rem" onclick="window.close()"">
                    <i class='bx bxs-x-circle'></i>
                    Quit the page
                </button>
                <button class="data-flex" style="gap: .25rem" onclick="window.location.reload()">   
                    <i class='bx bxs-log-in-circle'></i> 
                    Submit another one
                </button>
            </div>
        </div>
    </div>
    
    
    <div class="header">
        <div class="data-flex">
            <img src="https://griffins-air.club/wp-content/uploads/2021/10/unnamed.jpg" alt="">
            <h1>Altyra <br><b>Flight Register</b></h1>
        </div>

        <div class="data-flex">
            <p class="active" id="menu1" onclick="module_switch('menu1')">Submit</p>
        </div>
    </div>

    <div class="page-wrapper">

        <div class="menu1 main">
            <div class="data-flex" style="gap: 0;">
                <img src="media/img/plane.gif" alt="" style="width: 4rem;" id="submitimg">
                <h1>Submit Your Flight</h1>
            </div>
            

            <div class="data-flex-v submitflight" style="justify-content: flex-start;align-items: flex-start;">
                <h2>Flight</h2>

                <div class="main-option-grid">
                    <div class="data-flex-v pointer" >
                        <h3>Flight type</h3>
                        <div class="data-flex nselect" id="nselect_flighttype"  onclick="unlock_nlist('nselect_flighttype');">
                            <p></p>
                            <i class='bx bxs-chevron-down'></i>
                        </div>
                        <div class="nlist">
                            <p onclick="changeValue('nselect_flighttype','Owner')">Owner</p>
                            <p onclick="changeValue('nselect_flighttype','Members')">Members</p>
                            <p onclick="changeValue('nselect_flighttype','Alps Tour')">Alps Tour</p>
                            <p onclick="changeValue('nselect_flighttype','-1 Hour')">-1 Hour</p>
                            <p onclick="changeValue('nselect_flighttype','+1 Hour')">+1 Hour</p>
                            <p onclick="changeValue('nselect_flighttype','Instruction')">Instruction</p>
                        </div>
                    </div>

                    <div class="data-flex-v">
                        <h3>Flight route (ICAO)</h3>
                        <div class="data-flex">
                            <input type="text" pattern="[a-zA-Z]*" placeholder="Departure" maxlength="4" oninput="updateUpperCase('route_start')" id="route_start">
                            <input type="text" pattern="[a-zA-Z]*" placeholder="Arrival" maxlength="4" oninput="updateUpperCase('route_end')" id="route_end">
                        </div>
                        
                    </div>

                    <div class="data-flex-v">
                        <h3>Flight date</h3>
                        <input type="date" value="2022-08-22" style="max-width: none;" id="flight_date">
                    </div>

                    <div class="data-flex-v pointer" >
                        <h3>Pilot in charge</h3>
                        <div class="data-flex nselect" id="nselect_flightpilot"  onclick="unlock_nlist('nselect_flightpilot');">
                            <p></p>
                            <i class='bx bxs-chevron-down'></i>
                        </div>
                        <div class="nlist">
                            <p onclick="changeValue('nselect_flightpilot','EST')">EST</p>
                            <p onclick="changeValue('nselect_flightpilot','PRA')">PRA</p>
                            <p onclick="changeValue('nselect_flightpilot','POF')">POF</p>
                            <p onclick="changeValue('nselect_flightpilot','MPT')">MPT</p>
                            <p onclick="changeValue('nselect_flightpilot','MIEL')">MIEL</p>
                        </div>
                    </div>
                        
                    
                </div>



                <h2>Fuel Usage</h2>



                <div id="sionfuelflex" class="main-option-grid" style="margin-top: 1rem;">
                    <div class="data-flex-v" style="align-items: flex-start;">
                        <h3>Fuel Loaded<br><b> in Sion</b></h3>
                        <input type="number" maxlength="5" max="10000" id="sion_liters" placeholder="In litres">
                    </div>

                    <div class="data-flex-v" style="align-items: flex-start;">
                        <h3>Fuel Purchased<br><b>Elsewhere</b></h3>
                        <input type="number" maxlength="5" max="10000" id="fuel_liters" placeholder="In litres">
                    </div>

                    <div class="data-flex-v" style="align-items: flex-start;" id="fuel_pricepaid">
                        <h3>Price Paid For Fuel<br><b>Outside Sion</b></h3>
                        <input type="number" max="10000" id="fuel_pricepaid_value" placeholder="In total">
                    </div>

                    <div class="data-flex-v pointer" >
                        <h3>Currency for your fuel<br><b>purchase outside Sion</b></h3>
                        <div class="data-flex nselect" id="nselect_fuelcurrency"  onclick="unlock_nlist('nselect_fuelcurrency');">
                            <p></p>
                            <i class='bx bxs-chevron-down'></i>
                        </div>
                        <div class="nlist">
                            <p onclick="changeValue('nselect_fuelcurrency','CHF')">CHF</p>
                            <p onclick="changeValue('nselect_fuelcurrency','EUR')">EUR</p>
                            <p onclick="changeValue('nselect_fuelcurrency','GBP')">GBP</p>
                        </div>
                    </div>



                    <div class="data-flex-v" style="align-items: flex-start;" id="fuel_receipt_div">
                        <h3>Receipt from your purchase<br>(If you bought fuel outside Sion)</h3>

                        <div class="data-flex background pointer" >
                            <label for="fuel_receipt" id="fuel_receipt_preview" class="pointer">Upload image</label>
                            <input type="file" name="photo" id="fuel_receipt" style="opacity: 0;position: absolute;z-index: -1;" oninput="updateImgName('fuel_receipt_preview','fuel_receipt')" accept=".png,.jpg,.heic" >
                        </div>
                        

                    
                    </div>

                    

                    
                </div>

                <h2>Log Book Times</h2>
                <div class="main-option-grid" id="log">
                    <div class="data-flex-v" style="align-items: flex-start;">
                        <h3>Total Flight Time<br>(In Hours:Minutes)</h3>
                        <input class="html-duration-picker" data-hide-seconds id="log_total" style="max-width: 15ch;">
                    </div>

                    <div class="data-flex-v" style="align-items: flex-start;">
                        <h3>Landing Time<br>(In Hours:Minutes (PM/AM Optional))</h3>
                        <input type="time" id="log_end"style="max-width: 15ch;">
                    </div>
                </div>


                <h2>Fuel Status</h2>

                <div class="main-option-grid">
                    <div class="data-flex-v" style="align-items: flex-start;">
                        <h3>Total Fuel Used (USG from Avydine)</h3>
                        <input type="number" placeholder="In US Gallons" maxlength="5" max="10000" id="fuel_total" style="max-width: 10ch;">
                    </div>

                </div>

                
                

                <h2>Authentication</h2>
                <div class="main-option-grid">
                    <div class="data-flex-v" style="align-items: flex-start;">
                        <h3>The password given to you</h3>
                        <input type="password" placeholder="4 Characters" maxlength="4" id="auth_code">
                    </div>
                </div>

                <h2>Submit</h2>

                <div class="data-flex" id="submitbuttons">
                    <button class="alt">
                        Need help with the form?
                    </button>
                    <button onclick="submitFlightData()">    
                        Submit your flight data
                    </button>
                </div>
                
                




                

            </div>
        </div>
    </div>

    <div class="footer">
        <div class="data-flex">
            <img src="https://griffins-air.club/wp-content/uploads/2021/10/unnamed.jpg" alt="" style="height: 2rem;">
            <h3>
                Copyright © 2022 Griffin's Air / Altyra. Built by Nitlix. All rights reserved.
            </h3>
        </div>
        
        
    </div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="wrapper.js"></script>
<script src="html-duration-picker.js"></script>

<script>


    function aId(id){
        return document.getElementById(id);
    }

    function failNotif(msg, delay){
        aId('fail-text').innerText = msg;
        aId('fail-display').classList.add('active');
        setTimeout(function(){
            aId('fail-display').classList.remove('active');
        },parseInt(delay));
    }

    function successNotif(msg, delay){
        aId('success-text').innerText = msg;
        aId('success-display').classList.add('active');
        setTimeout(function(){
            aId('success-display').classList.remove('active');
        },parseInt(delay));
    }

    function module_switch(module){
        e = document.querySelectorAll('.header p')
        for(i=0;i<e.length;i++){
            e[i].classList.remove('active')
        }
        aId(module).classList.add('active')
    }

    function changeValue(id, value){ 
        document.querySelectorAll("#"+id+' p')[0].innerText = value;
        unlock_nlist(id);
    }

    function unlock_nlist(id){
        e = document.querySelectorAll('#'+id+" + .nlist")[0]
        
        if (e.style.maxHeight == "0rem"){
            e.style.maxHeight = e.scrollHeight + "px";
            setTimeout(()=>{
                e.style.padding = ".5rem";
            },500)

        }
        else {
            e.style.maxHeight = "0rem";
            e.style.padding = "0rem";
        }
    }

    function updateFuel(){
        e = aId('sionfuel')
        if (e.checked){
            aId('fuel_pricepaid').style.display = "none";
            aId('fuel_receipt_div').style.display = "none";
        }
        else {
            aId('fuel_pricepaid').style.display = "block";
            aId('fuel_receipt_div').style.display = "block";

        }
    }

    function doneDisplay(){
        aId('done-wrapper').style.display = "grid";
        setTimeout(()=>{
            aId('done-wrapper').style.opacity = "1";
        },100)
    }   

    function updateUpperCase(id) {
        aId(id).value = aId(id).value.toUpperCase();
    }  
    
    function updateImgName(id,selfid){
        aId(id).innerText = aId(selfid).value.replace('C:\\fakepath\\','') + " (Click to upload a different one)"
    }

    function submitFlightData(){

        successNotif('Submitting your flight data...',2500);


        var submitdict = {
            "flight": {

            },
            "fuel": {

            },
            "log":{
            }
        }

        submitdict['flight']['type'] = document.querySelectorAll('#nselect_flighttype p')[0].innerText;

        if (aId('route_start').value.length == 4){
            if (aId('route_end').value.length == 4){
                submitdict['flight']['route'] = [aId('route_start').value,aId('route_end').value];
            }
            else {
                failNotif("Invalid Arrival Airport Code!",2500);
                return
            }
        }
        else {
            failNotif("Invalid Departure Airport Code!",2500);
            return
        }

        submitdict['flight']['date'] = aId('flight_date').value;

       
        if (aId('sion_liters').value.length == 0){
            submitdict['fuel']['sionliters'] = "0";
        }
        else {
            submitdict['fuel']['sionliters'] = aId('sion_liters').value.replace('e','');
        }

        
        if (aId('fuel_liters').value.length == 0){
            submitdict['fuel']['elseliters'] = "0";
        }
        else {
            submitdict['fuel']['elseliters'] = aId('fuel_liters').value.replace('e','');
        }

        if (aId('fuel_pricepaid_value').value.length == 0){
            submitdict['fuel']['paid'] = "0";
        }
        else {
            submitdict['fuel']['paid'] = aId('fuel_pricepaid_value').value.replace('e','');
        }

        




        if (aId('log_total').value.length == 0){
            failNotif("Invalid Flight Duration Time",2500);
            return
        }
        if (aId('log_end').value.length == 0){
            failNotif("Invalid Log Arrival Time",2500);
            return
        }

        submitdict['log']['time']= [aId('log_total').value,aId('log_end').value];



        if (aId('fuel_total').value.length == 0){
            submitdict['log']['fuel'] = "0";
        }
        else {
            submitdict['log']['fuel'] = aId('fuel_total').value.replace('e','');
        }

        submitdict['fuel']['currency'] = document.querySelectorAll('#nselect_fuelcurrency p')[0].innerText;
        submitdict['flight']['pilot'] = document.querySelectorAll('#nselect_flightpilot p')[0].innerText;



        if (aId('auth_code').value.length != 4){
            failNotif('Invalid Authentication Code',2500);
            return
        }
        else {
            submitdict['auth'] = aId('auth_code').value.toUpperCase();
            
        }
        
        console.log(submitdict);

        url='https://api.nitlix.pro/api/v1/griffins/submit'

        var formData = new FormData();

        rdata = $('#fuel_receipt').prop('files')[0]
        if (rdata == null){
            rdata = "N/A"
        }
        
        //formData.append("img", rdata);
        
        formData.append("data", JSON.stringify(submitdict));

        formData.append("file", rdata);
        console.log(formData.get('file'))
        

    
        $.ajax({
            url: "https://api.nitlix.pro/api/v1/griffins/submit",
            type: "POST",
            data: formData,
            success: function (msg) {
                console.log(msg)
                if (msg['OK']){
                    successNotif(msg['resp'],2500);
                }
                else {
                    failNotif(msg['resp'],2500);
                }
                
                
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) { 
                failNotif(errorThrown,2500);
            },
            processData: false,
            contentType: false,
        });

        
    }


    window.onload=()=>{
        nitChangeScreen(smallerpls = false);

        var date = new Date();
        var currentDate = date.toISOString().substring(0,10);
        var currentTime = date.toISOString().substring(11,16);

        document.getElementById('flight_date').value = currentDate;
        document.getElementById('log_end').value = currentTime;

        
        changeValue('nselect_flighttype','Owner');
        changeValue('nselect_fuelcurrency','CHF');
        changeValue('nselect_flightpilot','EST');
    }
</script>
</body>
</html>